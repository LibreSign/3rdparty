name: Composer

on:
  pull_request:
  push:
    branches:
      - master
      - stable*

permissions:
  contents: read

jobs:
  php:
    runs-on: ubuntu-latest

    name: Check vendor changes
    steps:
    - name: Checkout
      uses: actions/checkout@08c6903cd8c0fde910a37f88322edcfb5dd907a8 # v5.0.0
      with:
        persist-credentials: false

    - name: Set up php
      uses: shivammathur/setup-php@bf6b4fbd49ca58e4608c9c89fba0b8d90bd2a39f # v2.35.5
      with:
        php-version: 8.1
        coverage: none

    - name: Enforce --no-dev
      run: |
        bash -c "[[ \"`cat composer/composer/installed.json | jq .dev`\" == \"false\" ]] || ( echo 'Please only commit after installing with \"composer install --no-dev\"' && exit 1 )"

    - name: Update composer
      run: sudo composer self-update && composer --version

    - name: Delete dependencies
      run: |
        rm -rf ./composer/*/
        rm -rf ./vendor/*/

    - name: Download dependencies
      run: composer install --no-dev

    - name: Remove tests and other untracked files
      run: git clean -X -d -f

    - name: Dump Autoload
      run: composer dump-autoload

    - name: Check vendor changes
      run: |
        bash -c "[[ ! \"`git status --porcelain . ':!composer/composer/installed.json' ':!composer/composer/installed.php' ':!composer/composer/package-versions-deprecated/src/PackageVersions/Versions.php' `\" ]] || ( echo 'Uncommited vendor changes' && git status && git diff && exit 1 )"
